<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TripHoppa ¬∑ Ops Console</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --brand:#32236F;--brand-lt:#3d2b87;--accent:#FF4F9E;
  --ink:#16162a;--muted:#6e7191;--border:#e4e4f0;
  --surface:#f6f6fc;--white:#ffffff;--radius:14px;
  --shadow:0 2px 16px rgba(50,35,111,0.07);
  --shadow-md:0 6px 28px rgba(50,35,111,0.12);
  --shadow-lg:0 16px 48px rgba(50,35,111,0.18);
  --s0-bg:#dbeafe;--s0-tx:#1e40af;
  --s1-bg:#fef9c3;--s1-tx:#854d0e;
  --s2-bg:#bfdbfe;--s2-tx:#1d4ed8;
  --s3-bg:#f3e8ff;--s3-tx:#6b21a8;
  --s4-bg:#fef08a;--s4-tx:#713f12;
  --s5-bg:#dcfce7;--s5-tx:#15803d;
}
html{font-size:14px}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--surface);color:var(--ink);min-height:100vh;display:flex}
.sidebar{width:220px;min-height:100vh;background:var(--brand);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;box-shadow:4px 0 24px rgba(50,35,111,0.15)}
.sidebar-logo{padding:24px 22px 20px;border-bottom:1px solid rgba(255,255,255,0.08)}
.logo-mark{display:flex;align-items:center;gap:10px}
.logo-icon{width:34px;height:34px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.logo-text .name{font-size:15px;font-weight:700;color:#fff;letter-spacing:-.3px;line-height:1}
.logo-text .tagline{font-size:10px;color:rgba(255,255,255,0.4);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:1px;margin-top:3px}
.nav{padding:16px 0;flex:1}
.nav-section-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:rgba(255,255,255,0.3);padding:14px 22px 6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 22px;font-size:13.5px;font-weight:500;color:rgba(255,255,255,0.55);cursor:pointer;border-left:3px solid transparent;transition:all .16s;user-select:none}
.nav-item:hover{color:rgba(255,255,255,0.9);background:rgba(255,255,255,0.05)}
.nav-item.active{color:#fff;border-left-color:var(--accent);background:rgba(255,255,255,0.09)}
.nav-icon{font-size:15px;width:18px;text-align:center}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;font-family:'DM Mono',monospace}
.sidebar-footer{padding:16px 22px;border-top:1px solid rgba(255,255,255,0.08)}
.sidebar-footer .ops-label{font-size:11px;color:rgba(255,255,255,0.3);font-family:'DM Mono',monospace}
.sidebar-footer .ops-name{font-size:13px;color:rgba(255,255,255,0.7);font-weight:500;margin-top:2px}
.main{margin-left:220px;flex:1;padding:32px 36px;min-height:100vh}
.view{display:none}.view.active{display:block}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;gap:16px}
.page-title{font-size:22px;font-weight:700;color:var(--ink);letter-spacing:-.4px;line-height:1.2}
.page-sub{font-size:13px;color:var(--muted);margin-top:4px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:26px}
.stat-card{background:var(--white);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border:1px solid var(--border);position:relative;overflow:hidden;cursor:default;transition:transform .2s,box-shadow .2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.stat-card::after{content:attr(data-icon);position:absolute;right:14px;top:14px;font-size:22px;opacity:.15}
.stat-stripe{height:3px;border-radius:3px;margin-bottom:16px}
.stat-label{font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:8px}
.stat-value{font-size:28px;font-weight:700;color:var(--ink);letter-spacing:-1px;font-family:'DM Mono',monospace;line-height:1}
.stat-sub{font-size:11.5px;color:var(--muted);margin-top:6px}
.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:180px;max-width:300px}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none}
.search-input{width:100%;padding:9px 12px 9px 33px;border:1px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--white);outline:none;transition:border-color .16s,box-shadow .16s;color:var(--ink)}
.search-input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(50,35,111,0.08)}
.filter-sel{padding:9px 12px;border:1px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--white);outline:none;cursor:pointer;color:var(--ink)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 17px;border-radius:9px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .16s;white-space:nowrap}
.btn-primary{background:var(--brand);color:#fff}
.btn-primary:hover{background:var(--brand-lt);box-shadow:0 4px 12px rgba(50,35,111,0.25)}
.btn-accent{background:var(--accent);color:#fff}
.btn-accent:hover{opacity:.9;box-shadow:0 4px 12px rgba(255,79,158,0.3)}
.btn-ghost{background:var(--white);color:var(--ink);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface)}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-sm{padding:6px 12px;font-size:12px}
.table-card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{padding:12px 16px;text-align:left;font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);background:var(--surface);border-bottom:1px solid var(--border);white-space:nowrap;user-select:none}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s;cursor:pointer}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:#fafafd}
td{padding:12px 16px;vertical-align:middle}
.mono{font-family:'DM Mono',monospace;font-size:12px}
.tracking-chip{font-family:'DM Mono',monospace;font-size:11.5px;font-weight:500;color:var(--brand);background:rgba(50,35,111,0.07);padding:3px 8px;border-radius:5px}
.customer-name{font-weight:600;color:var(--ink)}
.customer-detail{font-size:11.5px;color:var(--muted);margin-top:1px}
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap}
.badge .dot{width:5px;height:5px;border-radius:50%}
.b-payment{background:var(--s0-bg);color:var(--s0-tx)}
.b-warehouse{background:var(--s1-bg);color:var(--s1-tx)}
.b-transit{background:var(--s2-bg);color:var(--s2-tx)}
.b-arrived{background:var(--s3-bg);color:var(--s3-tx)}
.b-pickup{background:var(--s4-bg);color:var(--s4-tx)}
.b-delivered{background:var(--s5-bg);color:var(--s5-tx)}
.freight-tag{display:inline-block;font-size:11px;padding:2px 8px;border-radius:5px;font-weight:500}
.f-air{background:#e0f2fe;color:#0369a1}
.f-sea{background:#d1fae5;color:#065f46}
.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-top:1px solid var(--border);font-size:12.5px;color:var(--muted)}
.page-controls{display:flex;gap:5px;align-items:center}
.page-btn{width:30px;height:30px;border-radius:7px;border:1px solid var(--border);background:var(--white);cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;display:flex;align-items:center;justify-content:center;transition:all .14s;color:var(--ink)}
.page-btn:hover:not(:disabled):not(.active){border-color:var(--brand);color:var(--brand)}
.page-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.page-btn:disabled{opacity:.35;cursor:not-allowed}
.overlay{position:fixed;inset:0;background:rgba(22,22,42,0.45);backdrop-filter:blur(3px);z-index:900;display:none;align-items:center;justify-content:center;padding:20px}
.overlay.open{display:flex}
.modal{background:var(--white);border-radius:18px;width:100%;max-width:620px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .22s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-header{display:flex;align-items:flex-start;justify-content:space-between;padding:24px 28px 0;gap:12px}
.modal-title{font-size:17px;font-weight:700;color:var(--ink);letter-spacing:-.3px}
.modal-sub{font-size:13px;color:var(--muted);margin-top:3px}
.modal-close{width:32px;height:32px;border:none;background:var(--surface);border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;color:var(--muted);flex-shrink:0;transition:all .14s}
.modal-close:hover{background:var(--border);color:var(--ink)}
.modal-body{padding:20px 28px 28px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:22px}
.detail-label{font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);margin-bottom:4px}
.detail-value{font-size:14px;color:var(--ink);font-weight:500}
.status-section{background:var(--surface);border-radius:12px;padding:18px;margin-bottom:18px}
.status-section-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:14px}
.pipeline{display:flex;align-items:center;margin-bottom:18px;overflow-x:auto;padding-bottom:4px}
.pipeline-step{display:flex;flex-direction:column;align-items:center;gap:6px;flex:1;min-width:80px;position:relative;cursor:pointer}
.pipeline-step:not(:last-child)::after{content:'';position:absolute;top:14px;left:50%;width:100%;height:2px;background:var(--border);z-index:0}
.pipeline-step.done:not(:last-child)::after,.pipeline-step.current:not(:last-child)::after{background:var(--brand)}
.pipeline-dot{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);background:var(--white);display:flex;align-items:center;justify-content:center;font-size:12px;z-index:1;position:relative;transition:all .2s;flex-shrink:0}
.pipeline-step.done .pipeline-dot{background:var(--brand);border-color:var(--brand);color:#fff}
.pipeline-step.current .pipeline-dot{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 0 4px rgba(255,79,158,0.2)}
.pipeline-step-label{font-size:9.5px;text-align:center;color:var(--muted);font-weight:500;line-height:1.3;max-width:70px}
.pipeline-step.done .pipeline-step-label,.pipeline-step.current .pipeline-step-label{color:var(--ink);font-weight:600}
.status-options{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.status-opt{display:flex;align-items:center;gap:9px;padding:10px 12px;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:all .16s;background:var(--white);text-align:left}
.status-opt:hover{border-color:var(--brand);background:#fafafd}
.status-opt.selected{border-color:var(--brand);background:rgba(50,35,111,0.05)}
.status-opt-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.status-opt-name{font-size:12.5px;font-weight:600;color:var(--ink)}
.status-opt-num{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-left:auto}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);margin-bottom:6px}
.form-input,.form-textarea{width:100%;padding:10px 13px;border:1px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:13.5px;background:var(--white);outline:none;color:var(--ink);transition:border-color .16s,box-shadow .16s}
.form-input:focus,.form-textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(50,35,111,0.08)}
.form-textarea{resize:vertical;min-height:75px}
.modal-footer{display:flex;justify-content:flex-end;gap:10px;border-top:1px solid var(--border);margin-top:18px;padding-top:18px}
.toast-wrap{position:fixed;bottom:28px;right:28px;z-index:9999;display:flex;flex-direction:column;gap:10px;pointer-events:none}
.toast{background:var(--ink);color:#fff;padding:12px 18px;border-radius:10px;font-size:13px;font-weight:500;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;animation:toastIn .22s ease;max-width:320px}
.toast.success{background:#16a34a}.toast.error{background:#dc2626}.toast.info{background:var(--brand)}
@keyframes toastIn{from{opacity:0;transform:translateY(10px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .emoji{font-size:42px;margin-bottom:14px}
.empty-state .title{font-size:16px;font-weight:600;color:var(--ink);margin-bottom:6px}
.empty-state .sub{font-size:13px}
.loading-row td{text-align:center;padding:48px;color:var(--muted)}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin .7s linear infinite;display:inline-block;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.settings-card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border);padding:28px;margin-bottom:18px;max-width:600px}
.settings-title{font-size:14px;font-weight:700;color:var(--ink);margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.info-banner{background:rgba(50,35,111,0.05);border:1px solid rgba(50,35,111,0.15);border-radius:10px;padding:14px 16px;font-size:13px;color:var(--brand);margin-bottom:18px;line-height:1.55}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#d0d0e8;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#b0b0d0}
@media(max-width:900px){
  .sidebar{width:60px}
  .sidebar .logo-text,.sidebar .nav-item span:not(.nav-icon),.sidebar .nav-badge,
  .sidebar-footer .ops-name,.sidebar-footer .ops-label,.nav-section-label,.sidebar-logo .tagline{display:none}
  .sidebar-logo{padding:18px 12px}
  .nav-item{padding:12px;justify-content:center}
  .main{margin-left:60px;padding:24px 20px}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .detail-grid{grid-template-columns:1fr}
  .status-options{grid-template-columns:1fr}
}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">
      <div class="logo-icon">‚úàÔ∏è</div>
      <div class="logo-text">
        <div class="name">TripHoppa</div>
        <div class="tagline">Ops Console</div>
      </div>
    </div>
  </div>
  <nav class="nav">
    <div class="nav-section-label">Main</div>
    <div class="nav-item active" onclick="showView('orders')">
      <span class="nav-icon">üì¶</span><span>All Orders</span>
      <span class="nav-badge" id="nav-total">‚Äî</span>
    </div>
    <div class="nav-item" onclick="showView('tracking')">
      <span class="nav-icon">üó∫Ô∏è</span><span>Tracking</span>
    </div>
    <div class="nav-section-label">System</div>
    <div class="nav-item" onclick="showView('settings')">
      <span class="nav-icon">‚öôÔ∏è</span><span>Settings</span>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="ops-label">Logged in as</div>
    <div class="ops-name">Ops Team</div>
  </div>
</aside>

<main class="main">

  <!-- ORDERS -->
  <div class="view active" id="view-orders">
    <div class="page-header">
      <div>
        <div class="page-title">All Orders</div>
        <div class="page-sub">Click any row to view details and update tracking status</div>
      </div>
      <button class="btn btn-primary" onclick="loadData()">‚Üª Refresh</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card" data-icon="üì¶">
        <div class="stat-stripe" style="background:var(--brand)"></div>
        <div class="stat-label">Total Orders</div>
        <div class="stat-value" id="stat-total">‚Äî</div>
        <div class="stat-sub">all time</div>
      </div>
      <div class="stat-card" data-icon="üöö">
        <div class="stat-stripe" style="background:#3b82f6"></div>
        <div class="stat-label">In Transit</div>
        <div class="stat-value" id="stat-transit">‚Äî</div>
        <div class="stat-sub">actively shipping</div>
      </div>
      <div class="stat-card" data-icon="‚úÖ">
        <div class="stat-stripe" style="background:#22c55e"></div>
        <div class="stat-label">Delivered</div>
        <div class="stat-value" id="stat-delivered">‚Äî</div>
        <div class="stat-sub">completed</div>
      </div>
      <div class="stat-card" data-icon="‚è≥">
        <div class="stat-stripe" style="background:#f59e0b"></div>
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="stat-pending">‚Äî</div>
        <div class="stat-sub">awaiting action</div>
      </div>
    </div>
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input class="search-input" id="search-input" type="text"
          placeholder="Search name, tracking ID, phone‚Ä¶" oninput="applyFilters()" />
      </div>
      <select class="filter-sel" id="filter-status" onchange="applyFilters()">
        <option value="">All Statuses</option>
        <option>Payment Received</option>
        <option>At Warehouse (Origin)</option>
        <option>In Transit</option>
        <option>Arrived in Rwanda</option>
        <option>Ready for Pickup</option>
        <option>Delivered</option>
      </select>
      <select class="filter-sel" id="filter-origin" onchange="applyFilters()">
        <option value="">All Origins</option>
        <option>Canada</option><option>USA</option>
        <option>China</option><option>Dubai</option><option>UK</option>
      </select>
      <select class="filter-sel" id="filter-freight" onchange="applyFilters()">
        <option value="">All Freight</option>
        <option value="air">Air Cargo</option>
        <option value="sea">Sea Freight</option>
      </select>
    </div>
    <div class="table-card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Tracking ID</th><th>Customer</th><th>Route</th>
              <th>Freight</th><th>Amount</th><th>Status</th><th>Date</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="orders-tbody">
            <tr class="loading-row">
              <td colspan="8"><span class="spinner"></span> Loading orders‚Ä¶</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <span id="pagination-info">‚Äî</span>
        <div class="page-controls" id="pagination-controls"></div>
      </div>
    </div>
  </div>

  <!-- TRACKING -->
  <div class="view" id="view-tracking">
    <div class="page-header">
      <div>
        <div class="page-title">Tracking Overview</div>
        <div class="page-sub">Status pipeline across all active shipments</div>
      </div>
      <button class="btn btn-primary" onclick="loadData()">‚Üª Refresh</button>
    </div>
    <div id="tracking-pipeline-cards"></div>
  </div>

  <!-- SETTINGS -->
  <div class="view" id="view-settings">
    <div class="page-header">
      <div>
        <div class="page-title">Settings</div>
        <div class="page-sub">Dashboard configuration</div>
      </div>
    </div>
    <div class="settings-card">
      <div class="settings-title">üîó Apps Script Connection</div>
      <div class="info-banner">
        ‚úÖ URL is pre-configured ‚Äî the dashboard connects automatically on load.
        Only use the override below if your Apps Script URL changes after a redeployment.
      </div>
      <div class="form-group">
        <label class="form-label">Apps Script Web App URL</label>
        <input class="form-input" id="settings-url" type="url"
          placeholder="https://script.google.com/macros/s/‚Ä¶/exec" />
      </div>
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button class="btn btn-primary" onclick="saveSettings()">Override URL</button>
        <button class="btn btn-ghost" onclick="testConnection()">Test Connection</button>
        <button class="btn btn-ghost" onclick="resetToDefault()">Reset to Default</button>
      </div>
      <div id="conn-result" style="margin-top:12px;font-size:13px;color:var(--muted);"></div>
    </div>
    <div class="settings-card">
      <div class="settings-title">üìã Status Reference</div>
      <div id="status-reference"></div>
    </div>
  </div>

</main>

<!-- MODAL -->
<div class="overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modal-tracking-id">‚Äî</div>
        <div class="modal-sub" id="modal-customer-name">‚Äî</div>
      </div>
      <button class="modal-close" onclick="closeModalDirect()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="modal-detail-grid"></div>
      <div class="status-section">
        <div class="status-section-title">üìç Update Tracking Status</div>
        <div class="pipeline" id="modal-pipeline"></div>
        <div class="status-options" id="modal-status-options"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Internal Note (optional)</label>
        <textarea class="form-textarea" id="modal-note"
          placeholder="e.g. Held at customs, expected clearance Friday‚Ä¶"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModalDirect()">Cancel</button>
        <button class="btn btn-accent" id="modal-save-btn" onclick="saveStatus()">‚úì Update Status</button>
      </div>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toast-wrap"></div>

<script>
// ‚îÄ‚îÄ HARDCODED URL ‚Äî no setup needed, dashboard auto-connects on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZq9CGklFaOTOkA65Plkia8qRQ9gRJUMdB62CJlBZfFx6OUO_yNO2F95xjErKub6Ek/exec';
const OVERRIDE_KEY = 'th_ops_url_override';

function getScriptUrl() {
  return localStorage.getItem(OVERRIDE_KEY) || DEFAULT_SCRIPT_URL;
}

const STATUSES = [
  { key:'payment',   label:'Payment Received',      emoji:'üí≥', dot:'#3b82f6' },
  { key:'warehouse', label:'At Warehouse (Origin)',  emoji:'üè≠', dot:'#eab308' },
  { key:'transit',   label:'In Transit',             emoji:'‚úàÔ∏è', dot:'#6366f1' },
  { key:'arrived',   label:'Arrived in Rwanda',      emoji:'üá∑üáº', dot:'#a855f7' },
  { key:'pickup',    label:'Ready for Pickup',       emoji:'üì¨', dot:'#f97316' },
  { key:'delivered', label:'Delivered',              emoji:'‚úÖ', dot:'#22c55e' },
];

const BADGE_CLASS = {
  'Payment Received':'b-payment','At Warehouse (Origin)':'b-warehouse',
  'In Transit':'b-transit','Arrived in Rwanda':'b-arrived',
  'Ready for Pickup':'b-pickup','Delivered':'b-delivered',
};

const STATUS_DOT = {
  'Payment Received':'#3b82f6','At Warehouse (Origin)':'#eab308',
  'In Transit':'#6366f1','Arrived in Rwanda':'#a855f7',
  'Ready for Pickup':'#f97316','Delivered':'#22c55e',
};

let allOrders=[], filteredOrders=[], currentPage=1;
const PAGE_SIZE=15;
let activeOrder=null, selectedStatus='';

// NAVIGATION
function showView(name) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(item=>{
    if(item.getAttribute('onclick')===`showView('${name}')`) item.classList.add('active');
  });
  if(name==='settings') renderSettings();
  if(name==='tracking') renderTrackingPipeline();
}

// SETTINGS
function saveSettings() {
  const url=document.getElementById('settings-url').value.trim();
  if(!url){toast('Please enter a URL','error');return;}
  localStorage.setItem(OVERRIDE_KEY,url);
  toast('URL overridden ‚Äî reloading‚Ä¶','success');
  loadData();
}

function resetToDefault() {
  localStorage.removeItem(OVERRIDE_KEY);
  document.getElementById('settings-url').value=DEFAULT_SCRIPT_URL;
  toast('Reset to default URL','info');
  loadData();
}

function testConnection() {
  const url=document.getElementById('settings-url').value.trim()||getScriptUrl();
  const el=document.getElementById('conn-result');
  el.textContent='‚è≥ Testing‚Ä¶';
  fetch(url+'?action=ping')
    .then(r=>r.json())
    .then(d=>{el.style.color='#16a34a';el.textContent='‚úÖ Connected: '+(d.message||'OK');})
    .catch(e=>{el.style.color='#dc2626';el.textContent='‚ùå Failed: '+e.message;});
}

function renderSettings() {
  document.getElementById('settings-url').value=getScriptUrl();
  document.getElementById('status-reference').innerHTML=STATUSES.map((s,i)=>`
    <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="width:24px;height:24px;background:${s.dot};border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;font-weight:700;">${i+1}</span>
      <span style="font-size:14px;">${s.emoji}</span>
      <span style="font-weight:600;font-size:13.5px;">${s.label}</span>
    </div>`).join('');
}

// DATA
async function loadData() {
  setTableLoading(true);
  try {
    const res=await fetch(getScriptUrl()+'?action=getOrders');
    const data=await res.json();
    if(data.error) throw new Error(data.error);
    allOrders=data.orders||[];
    applyFilters();
    updateStats();
    updateNavBadge();
    toast('Loaded '+allOrders.length+' orders','success');
  } catch(e) {
    setTableError(e.message);
    toast('Failed to load: '+e.message,'error');
  }
}

function setTableLoading(on) {
  if(on) document.getElementById('orders-tbody').innerHTML=
    '<tr class="loading-row"><td colspan="8"><span class="spinner"></span> Fetching orders‚Ä¶</td></tr>';
}

function setTableError(msg) {
  document.getElementById('orders-tbody').innerHTML=`
    <tr><td colspan="8"><div class="empty-state">
      <div class="emoji">‚ö†Ô∏è</div>
      <div class="title">Could not load data</div>
      <div class="sub">${msg}</div>
    </div></td></tr>`;
}

// STATS
function updateStats() {
  document.getElementById('stat-total').textContent=allOrders.length;
  document.getElementById('stat-delivered').textContent=allOrders.filter(o=>o.status==='Delivered').length;
  document.getElementById('stat-transit').textContent=allOrders.filter(o=>o.status==='In Transit').length;
  document.getElementById('stat-pending').textContent=allOrders.filter(o=>!['Delivered','In Transit'].includes(o.status)).length;
}

function updateNavBadge() {
  document.getElementById('nav-total').textContent=allOrders.length;
}

// FILTERS
function applyFilters() {
  const q=document.getElementById('search-input').value.toLowerCase();
  const status=document.getElementById('filter-status').value;
  const origin=document.getElementById('filter-origin').value;
  const freight=document.getElementById('filter-freight').value;
  filteredOrders=allOrders.filter(o=>{
    const matchQ=!q||(o.trackingId||'').toLowerCase().includes(q)||(o.fullName||'').toLowerCase().includes(q)||(o.phone||'').toLowerCase().includes(q)||(o.email||'').toLowerCase().includes(q);
    return matchQ&&(!status||o.status===status)&&(!origin||o.origin===origin)&&(!freight||(o.freightType||'').toLowerCase()===freight);
  });
  currentPage=1;
  renderTable();
}

// TABLE
function renderTable() {
  const tbody=document.getElementById('orders-tbody');
  if(!filteredOrders.length){
    tbody.innerHTML='<tr><td colspan="8"><div class="empty-state"><div class="emoji">üì≠</div><div class="title">No orders found</div><div class="sub">Try adjusting your filters.</div></div></td></tr>';
    updatePagination(0);return;
  }
  const start=(currentPage-1)*PAGE_SIZE;
  const slice=filteredOrders.slice(start,start+PAGE_SIZE);
  tbody.innerHTML=slice.map(o=>`
    <tr onclick="openModal('${escHtml(o.trackingId)}')">
      <td><span class="tracking-chip">${escHtml(o.trackingId)}</span></td>
      <td><div class="customer-name">${escHtml(o.fullName)}</div><div class="customer-detail">${escHtml(o.phone)}</div></td>
      <td><span style="font-size:12px;">${escHtml(o.origin)} ‚Üí ${escHtml(o.destination)}</span></td>
      <td><span class="freight-tag ${o.freightType==='sea'?'f-sea':'f-air'}">${o.freightType==='sea'?'üö¢ Sea':'‚úàÔ∏è Air'}</span></td>
      <td>
        <div class="mono" style="font-weight:600;">USD ${Number(o.amountUSD||0).toFixed(2)}</div>
        <div style="font-size:11px;color:var(--muted);">RWF ${Number(o.amountRWF||0).toLocaleString()}</div>
      </td>
      <td>${statusBadge(o.status)}</td>
      <td style="font-size:12px;color:var(--muted);">${formatDate(o.timestamp)}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModal('${escHtml(o.trackingId)}')">Edit ‚Ä∫</button></td>
    </tr>`).join('');
  updatePagination(filteredOrders.length);
}

function statusBadge(status) {
  const cls=BADGE_CLASS[status]||'b-payment';
  const dot=STATUS_DOT[status]||'#aaa';
  return `<span class="badge ${cls}"><span class="dot" style="background:${dot}"></span>${escHtml(status||'Payment Received')}</span>`;
}

// PAGINATION
function updatePagination(total) {
  const pages=Math.ceil(total/PAGE_SIZE);
  const start=total?(currentPage-1)*PAGE_SIZE+1:0;
  const end=Math.min(currentPage*PAGE_SIZE,total);
  document.getElementById('pagination-info').textContent=total?`Showing ${start}‚Äì${end} of ${total}`:'No results';
  const ctrl=document.getElementById('pagination-controls');
  if(pages<=1){ctrl.innerHTML='';return;}
  let html=`<button class="page-btn" onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>‚Äπ</button>`;
  for(let i=1;i<=pages;i++){
    if(i===1||i===pages||Math.abs(i-currentPage)<=1)
      html+=`<button class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;
    else if(Math.abs(i-currentPage)===2)
      html+=`<button class="page-btn" disabled>‚Ä¶</button>`;
  }
  html+=`<button class="page-btn" onclick="changePage(${currentPage+1})" ${currentPage===pages?'disabled':''}>‚Ä∫</button>`;
  ctrl.innerHTML=html;
}

function changePage(p){currentPage=p;renderTable();window.scrollTo({top:0,behavior:'smooth'});}

// MODAL
function openModal(trackingId) {
  const order=allOrders.find(o=>o.trackingId===trackingId);
  if(!order) return;
  activeOrder=order;
  selectedStatus=order.status||'Payment Received';
  document.getElementById('modal-tracking-id').textContent=order.trackingId;
  document.getElementById('modal-customer-name').textContent=order.fullName+' ¬∑ '+(order.origin||'')+' ‚Üí '+(order.destination||'');
  const details=[
    {label:'Full Name',value:order.fullName},
    {label:'Phone',value:order.phone},
    {label:'Email',value:order.email},
    {label:'Route',value:`${order.origin} ‚Üí ${order.destination}`},
    {label:'Freight Type',value:order.freightType==='sea'?'üö¢ Sea Freight':'‚úàÔ∏è Air Cargo'},
    {label:order.freightType==='sea'?'Volume':'Weight',value:order.freightType==='sea'?(order.volume?order.volume+' CBM':'‚Äî'):(order.weight?order.weight+' kg':'‚Äî')},
    {label:'Special Goods',value:order.specialGoods||'No'},
    {label:'Amount USD',value:`USD ${Number(order.amountUSD||0).toFixed(2)}`},
    {label:'Amount RWF',value:`RWF ${Number(order.amountRWF||0).toLocaleString()}`},
    {label:'Booked On',value:formatDate(order.timestamp)},
  ];
  document.getElementById('modal-detail-grid').innerHTML=details.map(d=>`
    <div class="detail-item">
      <div class="detail-label">${d.label}</div>
      <div class="detail-value">${escHtml(String(d.value||'‚Äî'))}</div>
    </div>`).join('');
  renderPipeline();
  renderStatusOptions();
  document.getElementById('modal-note').value='';
  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow='hidden';
}

function renderPipeline() {
  const idx=STATUSES.findIndex(s=>s.label===selectedStatus);
  document.getElementById('modal-pipeline').innerHTML=STATUSES.map((s,i)=>{
    const done=i<idx,cur=i===idx;
    return `<div class="pipeline-step ${done?'done':''} ${cur?'current':''}" onclick="selectStatus('${s.label}')">
      <div class="pipeline-dot">${done?'‚úì':s.emoji}</div>
      <div class="pipeline-step-label">${s.label}</div>
    </div>`;
  }).join('');
}

function renderStatusOptions() {
  document.getElementById('modal-status-options').innerHTML=STATUSES.map((s,i)=>`
    <div class="status-opt ${selectedStatus===s.label?'selected':''}" onclick="selectStatus('${s.label}')">
      <span class="status-opt-dot" style="background:${s.dot}"></span>
      <span class="status-opt-name">${s.emoji} ${s.label}</span>
      <span class="status-opt-num">${i+1}/6</span>
    </div>`).join('');
}

function selectStatus(label){selectedStatus=label;renderPipeline();renderStatusOptions();}

function closeModal(e){if(e.target===document.getElementById('modal-overlay')) closeModalDirect();}
function closeModalDirect(){
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow='';
  activeOrder=null;
}

// SAVE STATUS
async function saveStatus() {
  if(!activeOrder) return;
  const note=document.getElementById('modal-note').value.trim();
  const btn=document.getElementById('modal-save-btn');
  btn.disabled=true;btn.textContent='‚è≥ Saving‚Ä¶';
  try {
    const params=new URLSearchParams({action:'updateStatus',trackingId:activeOrder.trackingId,status:selectedStatus,note:note});
    const res=await fetch(getScriptUrl()+'?'+params.toString());
    const data=await res.json();
    if(data.error) throw new Error(data.error);
    const idx=allOrders.findIndex(o=>o.trackingId===activeOrder.trackingId);
    if(idx!==-1){allOrders[idx].status=selectedStatus;allOrders[idx].lastUpdate=new Date().toISOString();}
    updateStats();applyFilters();closeModalDirect();
    toast('Status updated ‚Üí '+selectedStatus,'success');
  } catch(e) {
    toast('Update failed: '+e.message,'error');
  } finally {
    btn.disabled=false;btn.textContent='‚úì Update Status';
  }
}

// TRACKING VIEW
function renderTrackingPipeline() {
  const container=document.getElementById('tracking-pipeline-cards');
  if(!allOrders.length){
    container.innerHTML='<div class="empty-state"><div class="emoji">üó∫Ô∏è</div><div class="title">No data yet</div><div class="sub">Go to All Orders and hit Refresh first.</div></div>';
    return;
  }
  const groups={};
  STATUSES.forEach(s=>{groups[s.label]=[];});
  allOrders.forEach(o=>{
    const key=o.status||'Payment Received';
    if(groups[key]) groups[key].push(o);
    else groups['Payment Received'].push(o);
  });
  container.innerHTML=STATUSES.map(s=>{
    const orders=groups[s.label]||[];
    return `
      <div style="margin-bottom:18px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <span style="width:10px;height:10px;background:${s.dot};border-radius:50%;flex-shrink:0;"></span>
          <span style="font-weight:700;font-size:14px;">${s.emoji} ${s.label}</span>
          <span style="background:rgba(50,35,111,0.08);color:var(--brand);font-size:11px;font-weight:700;padding:2px 9px;border-radius:20px;font-family:'DM Mono',monospace;">${orders.length}</span>
        </div>
        ${orders.length?`
        <div class="table-card"><table>
          <thead><tr><th>Tracking ID</th><th>Customer</th><th>Route</th><th>Freight</th><th>Amount</th><th>Action</th></tr></thead>
          <tbody>${orders.map(o=>`
            <tr onclick="openModal('${escHtml(o.trackingId)}')">
              <td><span class="tracking-chip">${escHtml(o.trackingId)}</span></td>
              <td><div class="customer-name">${escHtml(o.fullName)}</div><div class="customer-detail">${escHtml(o.phone)}</div></td>
              <td style="font-size:12px;">${escHtml(o.origin)} ‚Üí ${escHtml(o.destination)}</td>
              <td><span class="freight-tag ${o.freightType==='sea'?'f-sea':'f-air'}">${o.freightType==='sea'?'üö¢ Sea':'‚úàÔ∏è Air'}</span></td>
              <td class="mono">USD ${Number(o.amountUSD||0).toFixed(2)}</td>
              <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModal('${escHtml(o.trackingId)}')">Update ‚Ä∫</button></td>
            </tr>`).join('')}
          </tbody></table></div>`
        :`<div style="padding:14px 18px;background:var(--white);border:1px solid var(--border);border-radius:var(--radius);color:var(--muted);font-size:13px;">No packages at this stage</div>`}
      </div>`;
  }).join('');
}

// TOAST
function toast(msg,type='info') {
  const wrap=document.getElementById('toast-wrap');
  const el=document.createElement('div');
  el.className='toast '+type;
  const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};
  el.innerHTML=`<span>${icons[type]||'‚ÑπÔ∏è'}</span> ${escHtml(msg)}`;
  wrap.appendChild(el);
  setTimeout(()=>el.remove(),3800);
}

// HELPERS
function escHtml(str){
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatDate(ts){
  if(!ts) return '‚Äî';
  try{return new Date(ts).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});}
  catch{return ts;}
}

// INIT ‚Äî auto-loads on page open, no configuration needed
window.addEventListener('DOMContentLoaded',()=>{
  loadData();
  renderSettings();
});
</script>
</body>
</html>
